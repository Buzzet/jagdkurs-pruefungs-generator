name: Deploy AI API

on:
  push:
    branches: [ main ]
    paths:
      - 'api/**'
      - '.github/workflows/deploy-api.yml'
  workflow_dispatch:

jobs:
  deploy-api:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build ./api --file ./api/Dockerfile --tag jagdkurs-ai-api:latest

      - name: Save Docker image as tar
        run: docker save jagdkurs-ai-api:latest > jagdkurs-ai-api.tar

      - name: Install SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          known_hosts: 'placeholder'

      - name: Accept host key
        run: ssh -o StrictHostKeyChecking=accept-new ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} 'echo ok'

      - name: Deploy artifacts via rsync
        run: |
          rsync -e "ssh" -avz jagdkurs-ai-api.tar ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.API_DEPLOY_PATH }}/
          rsync -e "ssh" -avz api/docker-compose.yml ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.API_DEPLOY_PATH }}/docker-compose.yml
          rsync -e "ssh" -avz api/.env.example ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.API_DEPLOY_PATH }}/.env.example

      - name: Deploy and restart API on server (with retry)
        run: |
          retry_ssh() {
            local cmd="$1"
            local tries=5
            local delay=5
            local n=1
            while [ $n -le $tries ]; do
              if ssh -o ConnectTimeout=20 -o ServerAliveInterval=10 -o ServerAliveCountMax=6 \
                ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "$cmd"; then
                return 0
              fi
              echo "SSH attempt $n/$tries failed. Retrying in ${delay}s..."
              sleep $delay
              n=$((n+1))
            done
            return 1
          }

          retry_ssh "mkdir -p ${{ secrets.API_DEPLOY_PATH }}"
          retry_ssh "if [ ! -f ${{ secrets.API_DEPLOY_PATH }}/.env ] && [ -f ${{ secrets.API_DEPLOY_PATH }}/.env.example ]; then cp ${{ secrets.API_DEPLOY_PATH }}/.env.example ${{ secrets.API_DEPLOY_PATH }}/.env; fi"
          retry_ssh "docker stop jagdkurs-ai-api || true"
          retry_ssh "docker load < ${{ secrets.API_DEPLOY_PATH }}/jagdkurs-ai-api.tar"
          retry_ssh "docker compose --file ${{ secrets.API_DEPLOY_PATH }}/docker-compose.yml up -d"
